# Purple Agent (Medical Participant) Docker Image
FROM python:3.13-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv for Google private packages
RUN pip install --no-cache-dir uv

# Set working directory
WORKDIR /app

# Copy requirements first for filtering
COPY requirements.txt .

# Filter out a2a-sdk, google-adk, and earthshaker from requirements.txt (installed via uv)
RUN grep -vE '^(a2a-sdk|google-adk|earthshaker)' requirements.txt > /tmp/requirements.txt && \
    pip install --no-cache-dir -r /tmp/requirements.txt && \
    uv pip install --system --no-cache a2a-sdk google-adk earthshaker && \
    rm /tmp/requirements.txt

# Copy application code
COPY medbench/ ./medbench/
COPY tutorial/ ./tutorial/

# Set Python path
ENV PYTHONPATH=/app:/app/tutorial/src

# Expose port
EXPOSE 9010

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:9010/health || exit 1

# Default command (purple agent - medical)
# SPECIALTY can be overridden via environment variable
ARG SPECIALTY=diabetes
ENV SPECIALTY=${SPECIALTY}
CMD ["sh", "-c", "python -m medbench.medical_agent --host 0.0.0.0 --port 9010 --specialty ${SPECIALTY}"]
